@using SUPREA_LOGISTICS.ViewModels;
@model Vehicle;
@{
    ViewData["Title"] = Model.UnitType;
    var firstPic = Model?.VehiclePictures?.FirstOrDefault();

}
@{  /* HEADER */
    <div class="d-flex flex-row justify-content-between align-items-center border-bottom mb-2">
        <div class="d-flex flex-row align-items-center gap-2 py-2">
            <div class="col-md-3 mb-2">
                @if (firstPic != null)
                {
                    <img src="@Url.Action("ViewPicture", "VehicleManagement", new { id = firstPic.PictureId })"
                         height="100"
                         width="100" />
                }
                else
                {
                    <img src="~/images/no-image.png"
                         height="100"
                         width="100" />
                }
            </div>
            <h2 class="text-primary">@Model.UnitModelSeries - @Model.VehicleId.ToString("0000")</h2>
        </div>
        <div class="h-100 d-flex gap-3 justify-content-end align-items-center">
            <a asp-action="EditVehicle" asp-route-id="@Model.VehicleId" class="fa-solid fa-pen text-primary text-decoration-none option-icon text-center d-flex align-items-center"></a>
            <div class="dropdown p-0 m-0 option-icon text-center  d-flex align-items-center" style="cursor: pointer">
                <a class="fa-solid fa-plus text-primary text-decoration-none dropdown-toggle-split" data-bs-toggle="dropdown"></a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" asp-action="CreateMaintenanceLog" asp-controller="MaintenanceLog" asp-route-vehicleId="@Model.VehicleId">New MaintenanceLog</a></li>
                    <li><a class="dropdown-item" href="#">New VehicleLog</a></li>
                    <li><a class="dropdown-item" asp-action="CreateVehicle">New Vehicle</a></li>
                </ul>
            </div>
            <a href="#" class="fa-solid fa-rotate text-primary text-decoration-none option-icon text-center  d-flex align-items-center" onclick="window.location.reload()"></a>
            <div class="dropdown p-0 m-0 option-icon text-center  d-flex align-items-center" style="cursor: pointer">
                <a class="fa-solid fa-ellipsis-vertical text-primary text-decoration-none dropdown-toggle-split" data-bs-toggle="dropdown">
                </a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Export</a></li>
                    <li><a class="dropdown-item" href="#">Export as PDF</a></li>
                </ul>
            </div>
        </div>
    </div>
}
@{  /* TABS */
    <ul class="nav nav-tabs" id="info">
        <li class="nav-item">
            <a class="nav-link active" href="#Properties">Properties</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#Pictures">Pictures</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#Maintenance">Maintenance Log</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#VehicleLog">Vehicle Log</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#Documents">Documents</a>
        </li>
    </ul>

}
<div id="content" class="p-2">

	@{	/* PROPERTIES */
    <div id="Properties" class="row gap-0">
        <div class="row g-3">

            <!-- General Information -->
            <div class="col-12 col-md-6 col-lg-4">
                <h4 class="w-100 border-bottom mb-1 pb-1">General Information</h4>
                <table class="w-100 table table-borderless">
                    <tr>
                        <td>Unit Type</td>
                        <td>@Model.UnitType</td>
                    </tr>
                    <tr>
                        <td>Unit Model / Series</td>
                        <td>@Model.UnitModelSeries</td>
                    </tr>
                    <tr>
                        <td>Brand</td>
                        <td>@Model.BrandMake</td>
                    </tr>
                    <tr>
                        <td>Year Model</td>
                        <td>@Model.YearModel</td>
                    </tr>
                    <tr>
                        <td>Plate No</td>
                        <td>@Model.PlateNo</td>
                    </tr>
                    <tr>
                        <td>Status</td>
                        <td>@Model.VehicleStatus</td>
                    </tr>
                </table>
            </div>

            <!-- Legal Details -->
            <div class="col-12 col-md-6 col-lg-4">
                <h4 class="w-100 border-bottom mb-1 pb-1">Legal Details</h4>
                <table class="w-100 table table-borderless">
                    <tr>
                        <td>Engine No</td>
                        <td>@Model.EngineNo</td>
                    </tr>
                    <tr>
                        <td>Chasis No</td>
                        <td>@Model.ChassisNo</td>
                    </tr>
                    <tr>
                        <td>OR / CR</td>
                        <td>
                                @if (Model.VehicleDocuments.Any(x => x.DocumentType == "OR/CR"))
                                {
                                    <a asp-controller="VehicleManagement" asp-action="DownloadDocument" asp-route-id="@Model.VehicleDocuments.FirstOrDefault(x => x.FileType == "OR/CR")?.DocumentId" class="text-decoration-none">
                                        @Model.VehicleDocuments.FirstOrDefault(x => x.FileType == "OR/CR")?.FileName
                                    </a>
                                }
                                else
                                {
                                    <span>N/A</span>
                                }
                        </td>
                    </tr>
                    <tr>
                        <td>Expiration</td>
                        <td>@Model.ExpirationDate</td>
                    </tr>
                </table>
            </div>

            <!-- Insurance & Assignment -->
            <div class="col-12 col-md-6 col-lg-4">
                <h4 class="w-100 border-bottom mb-1 pb-1">Insurance & Assignment</h4>
                <table class="w-100 table table-borderless">
                    <tr>
                        <td>Insurance</td>
                        <td>@Model.Insurance</td>
                    </tr>
                    <tr>
                        <td>Insurance Coverage</td>
                        <td>@Model.InsuranceCoverage</td>
                    </tr>
                    <tr>
                        <td>Insurance Provider</td>
                        <td>@Model.InsuranceProvider</td>
                    </tr>
                    <tr>
                        <td>Date Acquired</td>
                        <td>@Model.DateAcquired</td>
                    </tr>
                    <tr>
                        <td>Supplier</td>
                        <td>@Model.Supplier</td>
                    </tr>
                    <tr>
                        <td>Project ID</td>
                        <td>@Model.ProjectId</td>
                    </tr>
                    <tr>
                        <td>Site Location</td>
                        <td>@Model.SiteLocation</td>
                    </tr>
                    <tr>
                        <td>Current Driver</td>
                        <td>@Model.DriverInCharge?.FullName</td>
                    </tr>
                </table>
            </div>

        </div>

    </div>
	}      
    @{  /* PICTURES */   

    <div id="Pictures" class="visually-hidden">
        <div class="w-100 d-flex justify-content-between">
            <h4>Vehicle Pictures</h4>
            <div class="d-flex flex-coloumn g-2">
                <a class="btn border-0 m-0 p-0" data-bs-toggle="modal"
                        data-bs-target="#uploadPictureModal">
                    <i class="fa-plus h4 m-0 p-0"></i>
                </a>
            </div>
        </div>


        <div class="row">
            @if (Model.VehiclePictures.Where(x => x.IsAvailable).Any())
            {
                @foreach (var pic in Model.VehiclePictures.Where(x => x.IsAvailable))
                {
                    <div class="col-md-3 mb-2">
                        <img src="@Url.Action("ViewPicture", "VehicleManagement", new { id = pic.PictureId })"
                             class="img-thumbnail preview-image"
                             style="cursor:pointer; max-width:100%;"
                             data-bs-toggle="modal"
                             data-bs-target="#imageModal"
                             data-bs-src="@Url.Action("ViewPicture", "VehicleManagement", new { id = pic.PictureId })"
                             data-picture-id="@pic.PictureId" />
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <p class="text-center">No pictures available.</p>
                </div>
			}
        </div>
        @* Bootstrap Modal *@
        <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-body p-0">
                        <img id="modalImage" src="" class="img-fluid w-100" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" id="remove" data-id="">Remove</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }           
    @{  /* MAINTENANCE LOG */

        <div id="Maintenance" class="visually-hidden">
        <div class="w-100 d-flex justify-content-between">
            <h4>Maintenance Logs</h4>
            <div class="d-flex flex-coloumn g-2">
                <a class="btn border-0 m-0 p-0" asp-action="CreateMaintenanceLog" asp-controller="MaintenanceLog" asp-route-vehicleId="@Model.VehicleId">
                    <i class="fa-plus h4 m-0 p-0"></i>
                </a>
            </div>
        </div>
        <table class="table table-bordered table-hover w-100" id="MaintenanceTable">
            <thead>
                <tr>
                    <th>Maintenance ID</th>
                    <th>Date Issued</th>
                    <th>Maintenance Type</th>
                    <th>Details</th>
                    <th>Service Provider</th>
                    <th>Cost</th>
                    <th>Date Completed</th>
                    <th>Remarks</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.MaintenanceLogs.Any())
                {
                    @foreach(var log in Model.MaintenanceLogs)
                    {
                        <tr>
                            <td>@log.MaintenanceId</td>
                            <td>@(Convert.ToDateTime(log.CreatedAt).ToShortDateString())</td>
                            <td>@log.MaintenanceType</td>
                            <td>@log.Description</td>
                            <td>@log.ServiceProvider</td>
                            <td>@log.Cost</td>
                            <td>@log.MaintenanceDate.ToString("MM/dd/yyyy")</td>
                            <td></td>
                            <td>
                                <div>
                                    <a asp-action="EditMaintenanceLog"
                                       asp-controller="MaintenanceLog"
                                       asp-route-id="@log.MaintenanceId"
                                       class="mb-1">
                                        <i class="fa-solid fa-pen"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
				    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="text-center">No maintenance logs available.</td>
                    </tr>
				}
            </tbody>
        </table>
    </div>
    }    
    @{  /* VEHICLE LOG */
        <div id="VehicleLog" class="visually-hidden">
        <div class="w-100 d-flex justify-content-between">
            <h4>Vehicle Logs</h4>
            <div class="d-flex flex-coloumn g-2">
                <a class="btn border-0 m-0 p-0">
                    <i class="fa-plus h4 m-0 p-0"></i>
                </a>
            </div>
        </div>
        <table class="table table-bordered w-100">
            <thead>
                <tr>
                    <th>Log ID</th>
                    <th>Date</th>
                    <th>Driver Name</th>
                    <th>Purpose of Trip</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody>
                @if(Model.VehicleLogs.Any()){
                    @foreach (var log in Model.VehicleLogs)
                    {
                        <tr>
                            <td>@log.LogId</td>
                            <td>@log.LogDate.ToString("yyyy-MM-dd")</td>
                            <td>@log.DriverName</td>
                            <td>@log.Purpose</td>
                            <td>@* @log.Remarks *@</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="text-center">No vehicle logs available.</td>
					</tr>
                }
            </tbody>
        </table>
    </div>
    }
    @{  /* DOCUMENTS */

    <div id="Documents" class="visually-hidden">
        <div class="d-flex justify-content-between">
            <h4>Documents</h4>
            <div class="d-flex flex-coloumn g-2">
                <a class="btn border-0 m-0 p-0" data-bs-toggle="modal"
                   data-bs-target="#uploadDocumentModal">
                    <i class="fa-plus h4 m-0 p-0"></i>
                </a>
            </div>
        </div>
        <table class="table">
            <tr>
                <th>Type</th>
                <th>File</th>
                <th>Expiration</th>
                <td>Action</td>
            </tr>
            @if (Model.VehicleDocuments.Where(x => x.IsAvailable).Any())
            {
                @foreach (var doc in Model.VehicleDocuments.Where(x => x.IsAvailable))
                {
                    var isWord = doc.FileType.Contains("word");
                    <tr>
                        <td>@doc.DocumentType</td>
                        <td>@doc.FileName</td>
                        <td>@doc.ExpirationDate?.ToShortDateString()</td>
                        <td>
                            <a href="@Url.Action("DownloadDocument", "VehicleManagement", new { id = doc.DocumentId })"
                                class="btn btn-sm btn-success" target="_blank">Download</a>

                            @* Wrap the button in a span for tooltip if disabled *@
                            <span data-bs-toggle="tooltip"
                                    title="@(isWord ? "Preview not available for Word documents" : "Click to preview")">
                                <button type="button"
                                        class="btn btn-sm btn-primary @(isWord ? "disabled" : "")"
                                        data-bs-toggle="modal"
                                        data-bs-target="#docModal"
                                        data-bs-src="@Url.Action("ViewDocument", "VehicleManagement", new { id = doc.DocumentId })">
                                    Preview
                                </button>
                            </span>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
					<td colspan="4" class="text-center">No documents available.</td>
                </tr>
            }
        </table>
        <div class="modal fade" id="docModal">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body p-0">
                        <iframe id="modalDoc" src="" frameborder="0" style="width:100%; height:80vh;"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }

</div>
@* 
    ///
    MODALS 
    ///
*@
@{  /* PICTURE MODAL */ 
    <div class="modal fade" id="uploadPictureModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Upload Vehicle Picture</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                @* <a asp-action="UploadPicture">Add pic</a> *@
                @* <form asp-action="UploadPicture" method="post" enctype="multipart/form-data">
                <input type="hidden" name="vehicleId" value="@Model.VehicleId" />

                <input type="file" name="file" class="form-control" required />

                <button type="submit" class="btn btn-primary mt-2">Upload Picture</button>
            </form> *@
                <form asp-action="UploadPicture"
                      method="post"
                      enctype="multipart/form-data">

                    <div class="modal-body">

                        @* Pass vehicleId *@
                        <input type="hidden" name="vehicleId" value="@Model.VehicleId" />

                        <div class="mb-3">
                            <label class="form-label">Select Image</label>
                            <input type="file"
                                   name="file"
                                   class="form-control"
                                   required />
                        </div>

                    </div>

                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-secondary"
                                data-bs-dismiss="modal">
                            Cancel
                        </button>

                        <button type="submit"
                                class="btn btn-primary">
                            Upload
                        </button>
                    </div>

                </form>

            </div>
        </div>
    </div>
}
@{  /* DOCUMENT MODAL */ 
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Upload Vehicle Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form asp-action="UploadDocument"
                  asp-controller="VehicleManagement"
                  method="post"
                  enctype="multipart/form-data">

                <div class="modal-body">

                    @* Pass vehicleId *@
                    <input type="hidden" name="vehicleId" value="@Model.VehicleId" />

                    <div class="mb-3">
                        <label class="form-label">Document Type</label>
                        <select name="documentType" class="form-select" required>
                            <option value="">-- Select --</option>
                            <option value="OR/CR">OR / CR</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Registration">Registration</option>
                            <option value="Deed of Sale">Deed of Sale</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Expiration Date</label>
                        <input type="date" name="expirationDate" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Select File</label>
                        <input type="file" name="file" class="form-control"
                               accept=".pdf,.jpg,.jpeg,.png" required />
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Cancel
                    </button>

                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>

            </form>

        </div>
    </div>
</div>
}
@section Scripts{ 
        <script>
            document.addEventListener("DOMContentLoaded", function () {

                const imageModal = document.getElementById("imageModal");
                const modalImage = document.getElementById("modalImage");
                const removeBtn = document.getElementById("remove");

                imageModal.addEventListener("show.bs.modal", function (event) {
                    const trigger = event.relatedTarget;

                    const imgSrc = trigger.getAttribute("data-bs-src");
                    const pictureId = trigger.getAttribute("data-picture-id");

                    modalImage.src = imgSrc;
                    removeBtn.setAttribute("data-id", pictureId);
                });

                removeBtn.addEventListener("click", function () {
                    const pictureId = this.getAttribute("data-id");

                    if (!pictureId) return;

                    if (!confirm("Are you sure you want to remove this picture?")) {
                        return;
                    }

                    fetch('@Url.Action("DeletePicture", "VehicleManagement")', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "RequestVerificationToken":
                                document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        },
                        body: `pictureId=${pictureId}`
                    })
                    .then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert("Failed to remove picture.");
                        }
                    })
                    .catch(() => alert("An error occurred."));
                });
            });
        </script>
    <script>
           function showTabFromHash() {
            var hash = window.location.hash; // e.g., #Pictures
            if (!hash) hash = "#Properties"; // default tab
            $("#info a").removeClass("active");
            $("#info a[href='" + hash + "']").addClass("active");
            $("#content > div").addClass("visually-hidden");
            $(hash).removeClass("visually-hidden");
        }

        // Run on page load
        showTabFromHash();

        // When a tab is clicked
        $("#info a").on("click", function (e) {
            e.preventDefault();
            var hash = $(this).attr("href");
            window.location.hash = hash; // update URL
            showTabFromHash();
        });

        // Optional: handle back/forward browser buttons
        $(window).on("hashchange", function() {
            showTabFromHash();
        });

        var docModal = document.getElementById('docModal');
        docModal.addEventListener('show.bs.modal', function (event) {
            var btn = event.relatedTarget;
            var src = btn.getAttribute('data-bs-src');
            docModal.querySelector('#modalDoc').src = src;
        });
        docModal.addEventListener('hidden.bs.modal', function () {
            docModal.querySelector('#modalDoc').src = '';
        });

    </script>
}