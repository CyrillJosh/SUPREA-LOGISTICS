@using SUPREA_LOGISTICS.ViewModels
@model Vehicle

@{
    ViewData["Title"] = Model.UnitType;
    var firstPic = Model?.VehiclePictures?.FirstOrDefault();
}

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center border-bottom mb-2">
    <div class="d-flex align-items-center gap-3">
        <div class="col-md-3 mb-2">
            <img src="@(
                 firstPic != null
                 ? Url.Action("ViewPicture", "VehicleManagement", new { id = firstPic.PictureId })
                 : Url.Content("~/images/no-image.png")
                                )"
                 class="img-thumbnail"
                 style="height:100px; width:100px;" />
        </div>
        <h2 class="text-black mb-0">@Model.UnitModelSeries - @Model.VehicleId.ToString("0000")</h2>
    </div>

    <div class="d-flex align-items-center gap-2">

        <a asp-action="EditVehicle" asp-route-id="@Model.VehicleId" class="btn btn btn-sm btn-primary">
            <i class="fa-solid fa-pen me-1"></i> Edit
        </a>

        <div class="dropdown">
            <button class="btn btn-success btn btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fa-solid fa-plus me-1"></i> New
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" asp-action="CreateMaintenanceLog" asp-controller="MaintenanceLog" asp-route-vehicleId="@Model.VehicleId">
                        Maintenance Log
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#">Vehicle Log</a>
                </li>
                <li>
                    <a class="dropdown-item" asp-action="CreateVehicle">Vehicle</a>
                </li>
            </ul>
        </div>

        <a href="#" class="btn btn btn-sm btn-secondary" onclick="location.reload()">
            <i class="fa-solid fa-rotate me-1"></i> Refresh
        </a>

       @*  <div class="dropdown">
            <button class="btn btn-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis-vertical me-1"></i> Options
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">Export</a></li>
                <li><a class="dropdown-item" href="#">Export as PDF</a></li>
            </ul>
        </div> *@

    </div>

</div>

<!-- TABS -->
<ul class="nav nav-tabs mb-3 " id="vehicleTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active fw-bold" id="properties-tab" data-bs-toggle="tab" data-bs-target="#properties" type="button" role="tab">Properties</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold" id="pictures-tab" data-bs-toggle="tab" data-bs-target="#pictures" type="button" role="tab">Pictures</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button" role="tab">Maintenance Log</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold" id="vehiclelog-tab" data-bs-toggle="tab" data-bs-target="#vehiclelog" type="button" role="tab">Vehicle Log</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">Documents</button>
    </li>
</ul>

<div class="tab-content" id="vehicleTabsContent">

    <!-- PROPERTIES -->
    <div class="tab-pane fade show active" id="properties" role="tabpanel">
        <div class="row g-3">

            <!-- General Info -->
            <div class="col-md-4">
                <h5 class="border-bottom pb-1 fw-bold">General Information</h5>
                <table class="table table-bordered">
                    <tr><td>Ownership Status</td><td>@Model.OwnershipStatus</td></tr>
                    <tr><td>Unit Type</td><td>@Model.UnitType</td></tr>
                    <tr><td>Unit Model / Series</td><td>@Model.UnitModelSeries</td></tr>
                    <tr><td>Brand</td><td>@Model.BrandMake</td></tr>
                    <tr><td>Year Model</td><td>@Model.YearModel</td></tr>
                    <tr><td>Plate No</td><td>@Model.PlateNo</td></tr>
                    <tr><td>Status</td><td>@Model.VehicleStatuses.Last().Status</td></tr>
                </table>
            </div>

            <!-- Legal Details -->
            <div class="col-md-4">
                <h5 class="border-bottom pb-1 fw-bold">Legal Details</h5>
                <table class="table table-bordered">
                    <tr><td>Engine No</td><td>@Model.EngineNo</td></tr>
                    <tr><td>Chassis No</td><td>@Model.ChassisNo</td></tr>
                    <tr>
                        <td>OR / CR</td>
                        <td>
                            @if (Model.VehicleDocuments.Any(d => d.DocumentType == "OR/CR"))
                            {
                                <a href="#documents" class="text-decoration-none">View</a>
                            }
                            else
                            {

                                <span>N/A</span>
                            }
                        </td>
                    </tr>
                    <tr><td>Expiration</td><td>@Model.ExpirationDate?.ToShortDateString()</td></tr>
                </table>
            </div>

            <!-- Insurance & Assignment -->
            <div class="col-md-4">
                <h5 class="border-bottom pb-1 fw-bold">Insurance & Assignment</h5>
                <table class="table table-bordered">
                    <tr><td>Insurance</td><td>@Model.Insurance</td></tr>
                    <tr><td>Coverage</td><td>@Model.InsuranceCoverage</td></tr>
                    <tr><td>Provider</td><td>@Model.InsuranceProvider</td></tr>
                    <tr><td>Date Acquired</td><td>@Model.DateAcquired?.ToShortDateString()</td></tr>
                    <tr><td>Supplier</td><td>@Model.Supplier</td></tr>
                    <tr><td>Project ID</td><td>@Model.ProjectId</td></tr>
                    <tr><td>Site Location</td><td>@Model.SiteLocation</td></tr>
                    <tr><td>Driver</td><td>@Model.DriverInCharge?.FullName</td></tr>
                </table>
            </div>

        </div>
    </div>

    <!-- PICTURES -->
    <div class="tab-pane fade" id="pictures" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5>Vehicle Pictures</h5>
            <a class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadPictureModal"><i class="fa fa-plus"></i> Add</a>
        </div>
        <div class="row">
            @if (Model.VehiclePictures.Any(x => x.IsAvailable))
            {
                @foreach (var pic in Model.VehiclePictures.Where(x => x.IsAvailable))
                {
                    <div class="col-md-3 mb-2">
                        <img src="@Url.Action("ViewPicture", "VehicleManagement", new { id = pic.PictureId })"
                             class="img-thumbnail w-100"
                             style="cursor:pointer;"
                             data-bs-toggle="modal"
                             data-bs-target="#imageModal"
                             data-picture-name="@pic.FileName"
                             data-bs-src="@Url.Action("ViewPicture", "VehicleManagement", new { id = pic.PictureId })"
                             data-picture-id="@pic.PictureId" />
                    </div>
                }
            }
            else
            {
                <p class="text-center w-100">No pictures available.</p>
            }
        </div>
    </div>

    <!-- MAINTENANCE LOG -->
    <div class="tab-pane fade" id="maintenance" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5>Maintenance Logs</h5>
            <a class="btn btn-sm btn-outline-primary" asp-action="CreateMaintenanceLog" asp-controller="MaintenanceLog" asp-route-vehicleId="@Model.VehicleId"><i class="fa fa-plus"></i> Add</a>
        </div>
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Date Issued</th>
                    <th>Type</th>
                    <th>Details</th>
                    <th>Provider</th>
                    <th>Cost</th>
                    <th>Completed</th>
                    <th>Remarks</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.MaintenanceLogs.Any())
                {
                    foreach (var log in Model.MaintenanceLogs)
                    {
                        <tr>
                            <td>@log.MaintenanceId</td>
                            <td>@log.CreatedAt?.ToString("MM/dd/yyyy")</td>
                            <td>@log.MaintenanceType</td>
                            <td>@log.Description</td>
                            <td>@log.ServiceProvider</td>
                            <td>@log.Cost</td>
                            <td>@(log.DateCompleted.ToString()??"-")</td>
                            <td>@log.Remarks</td>
                            <td>
                                <a asp-action="EditMaintenanceLog" asp-controller="MaintenanceLog" asp-route-id="@log.MaintenanceId"><i class="fa fa-pen"></i></a>
                                <button class="btn btn-sm text-danger DeleteMLog" data-id="@log.MaintenanceId"><i class="fa fa-trash"></i></button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="9" class="text-center">No maintenance logs available.</td></tr>
                }
            </tbody>
        </table>
    </div>

    <!-- VEHICLE LOG -->
    <div class="tab-pane fade" id="vehiclelog" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5>Vehicle Logs</h5>
            <a asp-action="CreateVehicleLog" asp-controller="VehicleLog" asp-route-vehicleId="@Model.VehicleId" class="btn btn-sm btn-outline-primary"><i class="fa fa-plus"></i> Add</a>
        </div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Date Created</th>
                    <th>Description</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.VehicleLogs.Any())
                {
                    foreach (var log in Model.VehicleLogs)
                    {
                        <tr>
                            <td>@(Convert.ToDateTime(log.CreatedAt).ToString("MMMM dd, yyyy"))</td>
                            <td>@log.Description</td>
                            <td>@log.Remarks</td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="5" class="text-center">No vehicle logs available.</td></tr>
                }
            </tbody>
        </table>
    </div>

    <!-- DOCUMENTS -->
    <div class="tab-pane fade" id="documents" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5>Documents</h5>
            <a class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal"><i class="fa fa-plus"></i> Add</a>
        </div>
        <table class="table">
            <thead><tr><th>Type</th><th>File</th><th>Expiration</th><th>Action</th></tr></thead>
            <tbody>
                @if (Model.VehicleDocuments.Any(x => x.IsAvailable))
                {
                    foreach (var doc in Model.VehicleDocuments.Where(x => x.IsAvailable))
                    {
                        var isWord = doc.FileType.Contains("word");
                        <tr>
                            <td>@doc.DocumentType</td>
                            <td>@doc.FileName</td>
                            <td>@doc.ExpirationDate?.ToShortDateString()</td>
                            <td>
                                <a class="btn btn-sm btn-success" href="@Url.Action("DownloadDocument", "Document", new { id = doc.DocumentId })" target="_blank"><i class="fa fa-download"></i></a>
                                <button class="btn btn-sm btn-primary @(isWord ? "disabled" : "")" data-bs-toggle="modal" data-bs-target="#docModal" data-bs-src="@Url.Action("ViewDocument", "Document", new { id = doc.DocumentId })"><i class="fa fa-eye"></i></button>
                                <button class="btn btn-sm btn-danger DeleteDocument" data-id="@doc.DocumentId"><i class="fa fa-trash"></i></button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="4" class="text-center">No documents available.</td></tr>
                }
            </tbody>
        </table>
    </div>

</div>
@* 
    ///
    MODALS 
    ///
*@
<!-- PICTURE MODAL -->
<div class="modal fade" id="uploadPictureModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Upload Vehicle Picture</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            @* <a asp-action="UploadPicture">Add pic</a> *@
            @* <form asp-action="UploadPicture" method="post" enctype="multipart/form-data">
            <input type="hidden" name="vehicleId" value="@Model.VehicleId" />

            <input type="file" name="file" class="form-control" required />

            <button type="submit" class="btn btn-primary mt-2">Upload Picture</button>
        </form> *@
            <form asp-action="UploadPicture"
                    method="post"
                    enctype="multipart/form-data">

                <div class="modal-body">

                    @* Pass vehicleId *@
                    <input type="hidden" name="vehicleId" value="@Model.VehicleId" />

                    <div class="mb-3">
                        <label class="form-label">Select Image</label>
                        <input type="file"
                                name="file"
                                class="form-control"
                                required />
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Cancel
                    </button>

                    <button type="submit"
                            class="btn btn-primary">
                        Upload
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>
<!-- DOCUMENT MODAL -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Upload Vehicle Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form asp-action="UploadDocument"
                  asp-controller="VehicleManagement"
                  method="post"
                  enctype="multipart/form-data">

                <div class="modal-body">

                    @* Pass vehicleId *@
                    <input type="hidden" name="vehicleId" value="@Model.VehicleId" />

                    <div class="mb-3">
                        <label class="form-label">Document Type</label>
                        <select name="documentType" class="form-select" required>
                            <option value="">-- Select --</option>
                            <option value="OR/CR">OR / CR</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Registration">Registration</option>
                            <option value="Deed of Sale">Deed of Sale</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Expiration Date</label>
                        <input type="date" name="expirationDate" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Select File</label>
                        <input type="file" name="file" class="form-control"
                               accept=".pdf,.jpg,.jpeg,.png" required />
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Cancel
                    </button>

                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>

            </form>

        </div>
    </div>
</div>
<!-- IMAGE VIEW MODAL -->
<div class="modal fade" id="imageModal">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-body p-0">
                <img id="modalImage" src="" class="img-fluid w-100" />
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <p id="picModalName">TEST</p>
                <div>
                <button type="button" class="btn btn-danger" id="remove" data-id="">Remove</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- DOCUMENT VIEW MODAL -->
<div class="modal fade" id="docModal">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-0">
                <iframe id="modalDoc" src="" style="width:100%;height:80vh;" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function(){

            // Image modal
            const imageModal = document.getElementById("imageModal");
            const modalImage = document.getElementById("modalImage");
            const removeBtn = document.getElementById("remove");

            imageModal?.addEventListener("show.bs.modal", function(e){
                const trigger = e.relatedTarget;
                modalImage.src = trigger.getAttribute("data-bs-src");
                removeBtn.dataset.id = trigger.getAttribute("data-picture-id");

                // Set picture name dynamically if you have it
                const picName = trigger.getAttribute("data-picture-name") || "No name";
                document.getElementById("picModalName").textContent = picName;
            });

            removeBtn?.addEventListener("click", function(){
                const id = this.dataset.id;
                if(!confirm("Remove this picture?")) return;
                fetch('@Url.Action("DeletePicture", "VehicleManagement")',{
                    method:'POST',
                    headers:{
                        'Content-Type':'application/x-www-form-urlencoded',
                        'RequestVerificationToken':document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body:`pictureId=${id}`
                }).then(r=>{if(r.ok) location.reload(); else alert("Failed")}).catch(()=>alert("Error"));
            });

            // Delete logs/docs
            $(".DeleteMLog").click(function(){
                if(!confirm("Delete this maintenance log?")) return;
                $.post("/MaintenanceLog/DeleteMaintenanceLog",{id: $(this).data("id")})
                 .done(()=>location.reload())
                 .fail(()=>alert("Failed"));
            });
            $(".DeleteDocument").click(function(){
                if(!confirm("Delete this document?")) return;
                $.post("/Document/DeleteDocument",{id: $(this).data("id")})
                 .done(()=>location.reload())
                 .fail(()=>alert("Failed"));
            });

            // Document modal
            const docModal = document.getElementById("docModal");
            docModal?.addEventListener("show.bs.modal",function(e){
                this.querySelector("#modalDoc").src = e.relatedTarget.dataset.bsSrc;
            });
            docModal?.addEventListener("hidden.bs.modal",function(){
                this.querySelector("#modalDoc").src = "";
            });

            // Tabs with hash
            const vehicleTabs = document.querySelectorAll('#vehicleTabs button[data-bs-toggle="tab"]');

            function showTabFromHash() {
                let hash = window.location.hash.toLowerCase() || "#properties";
                let tabButton = Array.from(vehicleTabs).find(btn => btn.getAttribute("data-bs-target") === hash);
                if(tabButton) new bootstrap.Tab(tabButton).show();
            }

            showTabFromHash();

            vehicleTabs.forEach(btn => {
                btn.addEventListener('shown.bs.tab', function(e){
                    window.location.hash = e.target.getAttribute("data-bs-target");
                });
            });

            window.addEventListener('hashchange', showTabFromHash);

        });
    </script>
}

